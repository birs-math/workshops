#!/bin/bash
set -e

source /etc/profile.d/rvm.sh

export RAILS_ENV=development
export WORKSHOPS_HOME=/home/app/workshops
export RVM_BUNDLE="/usr/local/rvm/bin/rvm-exec 2.7.7 bundle"
export RVM_GEM="/usr/local/rvm/bin/rvm-exec 2.7.7 gem"

echo
echo "Welcome to OS:"
uname -v
cat /etc/issue
sed -i -e 's/mesg n .*true/tty -s \&\& mesg n/g' ~/.profile


echo
echo "Setting system timezone..."
export DEBIAN_FRONTEND=noninteractive DEBCONF_NONINTERACTIVE_SEEN=true
echo "tzdata tzdata/Areas select America" > /tmp/tz.txt
echo "tzdata tzdata/Zones/America select Edmonton" >> /tmp/tz.txt
debconf-set-selections /tmp/tz.txt
rm /etc/timezone
rm /etc/localtime
dpkg-reconfigure --frontend noninteractive tzdata

echo
echo "Ruby version:"
ruby -v

echo
echo "Node version:"
node --version

echo
echo "Yarn version:"
yarn --version

echo
echo "Installing bundler..."
${RVM_GEM} install bundler -v 2.4.22
# ${RVM_BUNDLE} update --bundler
# ${RVM_GEM} update --system
# ${RVM_GEM} install rubygems-bundler

# when updating Rails
# echo
# echo "Bundle update rails..."
# su app -c "cd ${WORKSHOPS_HOME} && ${RVM_BUNDLE} update rails"
# su app -c "cd ${WORKSHOPS_HOME} && ${RVM_BUNDLE} update"


echo
echo "Bundle install..."
su app -c "cd ${WORKSHOPS_HOME} && ${RVM_BUNDLE} install"
#su app -c "cd ${WORKSHOPS_HOME} && ${RVM_BUNDLE} update"

if [ ! -d "${GEM_HOME}/gems" ]; then
  echo
  echo "Gems not found in $GEM_HOME!"
  echo
  exit
fi

echo
echo "Changing to non-root file permissions..."
chown app:app -R /usr/local/rvm/gems

echo
echo "Running migrations..."
su app -c "cd ${WORKSHOPS_HOME} && ${RVM_BUNDLE} exec rails db:migrate"


# Default settings - ONLY NEEDED ONCE DURING INSTALLATION!!!
echo
echo "Adding default Settings..."
su app -c "cd ${WORKSHOPS_HOME} && ${RVM_BUNDLE} exec rake ws:init_settings"

# Default settings - ONLY NEEDED ONCE DURING INSTALLATION!!!
echo
echo "Creating admins..."
if [ -e lib/tasks/birs.rake ]; then
  su app -c "cd ${WORKSHOPS_HOME} && ${RVM_BUNDLE} exec rake birs:create_admins"
else
  su app -c "cd ${WORKSHOPS_HOME} && ${RVM_BUNDLE} exec rake ws:create_admins"
fi

echo
echo "Checking for WebPacker..."
if [ ! -e /home/app/workshops/bin/webpack ]; then
  echo "Installing webpacker..."
  RAILS_ENV=development ${RVM_BUNDLE} exec rails webpacker:install
  echo "Done!"
  echo
fi

if [ ! -e /home/app/workshops/tmp ]; then
  mkdir /home/app/workshops/tmp
  mkdir -p /home/app/workshops/vendor/cache
fi
chown app:app -R /home/app/workshops

echo
echo "Compiling Assets..."
su app -c "cd /home/app/workshops; yarn install" # --latest"
su app -c "cd /home/app/workshops; RAILS_ENV=development SECRET_KEY_BASE=token ${RVM_BUNDLE} exec rake assets:precompile --trace"
su app -c "cd /home/app/workshops; yarn"

echo
echo "Launching webpack-dev-server..."
su app -c "ruby /home/app/workshops/bin/webpack-dev-server &"
echo
echo "Starting web server..."
${RVM_BUNDLE} exec passenger start --min-instances 2
